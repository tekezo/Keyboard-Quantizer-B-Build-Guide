<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Build Firmware - Keyboard Quantizer B</title>
    <link
      rel="shortcut icon"
      href="/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="/assets/css/just-the-docs-default.css"
    />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-62G71JNR75"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-62G71JNR75");
    </script>
    <script
      type="text/javascript"
      src="/assets/js/vendor/lunr.min.js"
    ></script>
    <script
      type="text/javascript"
      src="/assets/js/just-the-docs.js"
    ></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Begin Jekyll SEO tag v2.7.1 -->
    <title>Build Firmware | Keyboard Quantizer B</title>
    <meta name="generator" content="Jekyll v4.1.1" />
    <meta property="og:title" content="Build Firmware" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content="市販/自作のキーボードを無線化したりキーマップを変更できる Keyboard Quantizer B の説明と設定 Documents and configurator of “Keyboard Quantizer B” which can make your keyboard wireless and configurable"
    />
    <meta
      property="og:description"
      content="市販/自作のキーボードを無線化したりキーマップを変更できる Keyboard Quantizer B の説明と設定 Documents and configurator of “Keyboard Quantizer B” which can make your keyboard wireless and configurable"
    />
    <link
      rel="canonical"
      href="/build_firmware/"
    />
    <meta
      property="og:url"
      content="/build_firmware/"
    />
    <meta property="og:site_name" content="Keyboard Quantizer B" />
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Build Firmware" />
    <script type="application/ld+json">
      {
        "headline": "Build Firmware",
        "@type": "WebPage",
        "description": "市販/自作のキーボードを無線化したりキーマップを変更できる Keyboard Quantizer B の説明と設定 Documents and configurator of “Keyboard Quantizer B” which can make your keyboard wireless and configurable",
        "url": "/build_firmware/",
        "@context": "https://schema.org"
      }
    </script>
    <!-- End Jekyll SEO tag -->
  </head>
  <body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-link"
        >
          <path
            d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
          ></path>
          <path
            d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
          ></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-search"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-chevron-right"
        >
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-file"
        >
          <path
            d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"
          ></path>
          <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>
    <div class="side-bar">
      <div class="site-header">
        <a
          href="/"
          class="site-title lh-tight"
        >
          Keyboard Quantizer B
        </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon">
            <use xlink:href="#svg-menu"></use>
          </svg>
        </a>
      </div>
      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
        <ul class="nav-list">
          <li class="nav-list-item">
            <a
              href="/"
              class="nav-list-link"
              >About</a
            >
          </li>
          <li class="nav-list-item">
            <a
              href="/setup/"
              class="nav-list-link"
              >Setup</a
            >
          </li>
          <li class="nav-list-item">
            <a
              href="/keymap/"
              class="nav-list-link"
              >Edit Keymap</a
            >
          </li>
          <li class="nav-list-item">
            <a
              href="/tips"
              class="nav-list-link"
              >Tips</a
            >
          </li>
          <li class="nav-list-item">
            <a
              href="/cli/"
              class="nav-list-link"
              >CLI</a
            >
          </li>
          <li class="nav-list-item active">
            <a
              href="/build_firmware/"
              class="nav-list-link active"
              >Build Firmware</a
            >
          </li>
          <li class="nav-list-item">
            <a
              href="/faq/"
              class="nav-list-link"
              >FAQ</a
            >
          </li>
          <li class="nav-list-item">
            <a
              href="/release_notes/"
              class="nav-list-link"
              >Release Notes</a
            >
          </li>
        </ul>
      </nav>
      <footer class="site-footer">
        This site uses
        <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>,
        a documentation theme for Jekyll.
      </footer>
    </div>
    <div class="main" id="top">
      <div id="main-header" class="main-header">
        <div class="search">
          <div class="search-input-wrap">
            <input
              type="text"
              id="search-input"
              class="search-input"
              tabindex="0"
              placeholder="Search Keyboard Quantizer B"
              aria-label="Search Keyboard Quantizer B"
              autocomplete="off"
            />
            <label for="search-input" class="search-label"
              ><svg viewBox="0 0 24 24" class="search-icon">
                <use xlink:href="#svg-search"></use></svg
            ></label>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>
      </div>
      <div id="main-content-wrap" class="main-content-wrap">
        <div id="main-content" class="main-content" role="main">
          <h1 class="no_toc" id="ファームウェアのビルドと書き込み">
            <a
              href="#ファームウェアのビルドと書き込み"
              class="anchor-heading"
              aria-labelledby="ファームウェアのビルドと書き込み"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            ファームウェアのビルドと書き込み
          </h1>
          <p>
            ベースはQMKファームウェアです。QMK自体の使い方については公式ドキュメントを参照してください。最新のQMKと乖離している場合があるため、Quantizer用リポジトリの<code
              class="language-plaintext highlighter-rouge"
              >doc/</code
            >フォルダ以下も参照することをおすすめします。
          </p>
          <ol id="markdown-toc">
            <li><a href="#環境構築" id="markdown-toc-環境構築">環境構築</a></li>
            <li><a href="#編集する" id="markdown-toc-編集する">編集する</a></li>
            <li>
              <a href="#ビルドする" id="markdown-toc-ビルドする">ビルドする</a>
              <ol>
                <li>
                  <a
                    href="#uf2ファイルを生成する"
                    id="markdown-toc-uf2ファイルを生成する"
                    >uf2ファイルを生成する</a
                  >
                </li>
                <li>
                  <a
                    href="#nrfutilで書き込む"
                    id="markdown-toc-nrfutilで書き込む"
                    >nrfutilで書き込む</a
                  >
                </li>
              </ol>
            </li>
            <li>
              <a
                href="#自分でレポートパーサを実装する"
                id="markdown-toc-自分でレポートパーサを実装する"
                >自分でレポートパーサを実装する</a
              >
              <ol>
                <li>
                  <a href="#サンプル" id="markdown-toc-サンプル">サンプル</a>
                </li>
                <li>
                  <a
                    href="#編集するファイルと関数"
                    id="markdown-toc-編集するファイルと関数"
                    >編集するファイルと関数</a
                  >
                </li>
                <li>
                  <a href="#keymapc" id="markdown-toc-keymapc">keymap.c</a>
                </li>
                <li>
                  <a
                    href="#レポートの形式を調べる"
                    id="markdown-toc-レポートの形式を調べる"
                    >レポートの形式を調べる</a
                  >
                </li>
              </ol>
            </li>
          </ol>
          <h2 id="環境構築">
            <a
              href="#環境構築"
              class="anchor-heading"
              aria-labelledby="環境構築"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            環境構築
          </h2>
          <p>
            QMKの導入手順にしたがって必要ソフトをインストールしてください。 Pro
            Microを使う場合とは異なり、<code
              class="language-plaintext highlighter-rouge"
              >arm-none-eabi-gcc</code
            >とその関連ソフトも必須です。
            なお、submoduleのlufaやChibiOSには依存していないため、これらの導入は飛ばしても構いません。
          </p>
          <ul>
            <li>
              BLE Micro Pro用のQMK Firmwareを<code
                class="language-plaintext highlighter-rouge"
                >qmk_firmware_bmp</code
              >という名前でclone
              <div class="language-plaintext highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code>git clone --depth 1 -b dev/ble_micro_pro https://github.com/sekigon-gonnoc/qmk_firmware.git qmk_firmware_bmp
</code></pre>
                </div>
              </div>
            </li>
            <li>
              ビルドに必要なツールをインストール
              <div class="language-plaintext highlighter-rouge">
                <div class="highlight">
                  <pre class="highlight"><code>cd qmk_firmware_bmp
./util/qmk_install.sh
</code></pre>
                </div>
              </div>
            </li>
            <li>
              uf2ブートローダを使わない場合、<a
                href="https://github.com/NordicSemiconductor/pc-nrfutil"
                target="_blank"
                >nrfutil</a
              >
              もインストール(要Python3.6–3.8)
              <div class="language-plaintext highlighter-rouge">
                <div class="highlight">
                  <pre class="highlight"><code>pip install nrfutil --user
</code></pre>
                </div>
              </div>
            </li>
          </ul>
          <h2 id="編集する">
            <a
              href="#編集する"
              class="anchor-heading"
              aria-labelledby="編集する"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            編集する
          </h2>
          <p>
            ファームウェアを編集する場合、<code
              class="language-plaintext highlighter-rouge"
              >keyboards/quantizer/kqb/</code
            >
            以下を編集してください
          </p>
          <h2 id="ビルドする">
            <a
              href="#ビルドする"
              class="anchor-heading"
              aria-labelledby="ビルドする"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            ビルドする
          </h2>
          <h3 id="uf2ファイルを生成する">
            <a
              href="#uf2ファイルを生成する"
              class="anchor-heading"
              aria-labelledby="uf2ファイルを生成する"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            uf2ファイルを生成する
          </h3>
          <p>
            <em
              >事前にUF2ブートローダを書き込んでいないとこの方法は使えません</em
            >
          </p>
          <p>
            <a href="/setup#bootloader-update"
              >uf2ブートローダの書き込み</a
            >
          </p>
          <p>
            uf2ブートローダが起動するとQuantizerがマスストレージとして認識されます。uf2ファイルをこのドライブにコピーすることでファームウェアを更新できます。
          </p>
          <p>以下のコマンドでuf2ファイルが生成されます。</p>
          <div class="language-plaintext highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code>  make keyboard_quantizer/kqb:default:uf2
</code></pre>
            </div>
          </div>
          <p>
            <a href="/cli">CLI</a
            >からdfuコマンドでブートローダを起動し、<code
              class="language-plaintext highlighter-rouge"
              >KQB_BOOT</code
            >という名前のドライブが表示されたらuf2ファイルをコピーしてください。
          </p>
          <h3 id="nrfutilで書き込む">
            <a
              href="#nrfutilで書き込む"
              class="anchor-heading"
              aria-labelledby="nrfutilで書き込む"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            nrfutilで書き込む
          </h3>
          <p>
            以下のコマンドでnrfutil用のzipファイルを生成し、書き込み待機状態になったらQuantizerをPCに接続してください。
          </p>
          <div class="language-plaintext highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code>  make &lt;keyboard&gt;:&lt;keymap&gt;:nrfutil
</code></pre>
            </div>
          </div>
          <h2 id="自分でレポートパーサを実装する">
            <a
              href="#自分でレポートパーサを実装する"
              class="anchor-heading"
              aria-labelledby="自分でレポートパーサを実装する"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            自分でレポートパーサを実装する
          </h2>
          <h3 id="サンプル">
            <a
              href="#サンプル"
              class="anchor-heading"
              aria-labelledby="サンプル"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            サンプル
          </h3>
          <ul>
            <li>
              Thinkpad trackpoint keyboard専用のパーサを実装した<a
                href="https://github.com/sekigon-gonnoc/qmk_firmware/blob/dev/sekigon/keyboards/keyboard_quantizer/keymaps/user_parser_sample/keymap.c"
                >サンプル</a
              >
            </li>
          </ul>
          <h3 id="編集するファイルと関数">
            <a
              href="#編集するファイルと関数"
              class="anchor-heading"
              aria-labelledby="編集するファイルと関数"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            編集するファイルと関数
          </h3>
          <ul>
            <li>
              自分で用意したパーサを使用するにはkeymap.cへの関数の実装が必要です
            </li>
          </ul>
          <h3 id="keymapc">
            <a href="#keymapc" class="anchor-heading" aria-labelledby="keymapc"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            keymap.c
          </h3>
          <ul>
            <li>
              <code class="language-plaintext highlighter-rouge"
                >void report_descriptor_parser_user(uint8_t interface, uint8_t
                const* desc, uint16_t len)</code
              >
              <ul>
                <li>受信したレポートディスクリプタを解析する</li>
                <li>
                  サンプルでは特定のキーボードの種類を想定しているのでレポートディスクリプタは解析不要のため、空の関数
                </li>
              </ul>
            </li>
            <li>
              <code class="language-plaintext highlighter-rouge"
                >void on_disconnect_device_user(uint8_t device)</code
              >
              <ul>
                <li>Quantizerからデバイスを抜いたときに実行する関数</li>
                <li>
                  サンプルではキーが押しっぱなしにならないように受信したデータをクリアしている
                </li>
              </ul>
            </li>
            <li>
              <code class="language-plaintext highlighter-rouge"
                >bool report_parser_user(uint8_t const* buf, uint16_t len,
                matrix_row_t* current_matrix)</code
              >
              <ul>
                <li>
                  受信したレポートを解析しキーマトリクスを更新する。戻り値はマトリクスの更新の有無
                </li>
                <li>
                  サンプルではVID:PIDがトラックポイントキーボードと一致した場合は専用の関数を、それ以外では6KROキーボード用の関数を呼び出している
                </li>
              </ul>
            </li>
          </ul>
          <h3 id="レポートの形式を調べる">
            <a
              href="#レポートの形式を調べる"
              class="anchor-heading"
              aria-labelledby="レポートの形式を調べる"
              ><svg viewBox="0 0 16 16" aria-hidden="true">
                <use xlink:href="#svg-link"></use></svg
            ></a>
            レポートの形式を調べる
          </h3>
          <p>
            <a href="/cli">CLI</a
            >のデバッグ機能を使ってどんなレポートが送られてくるか調べられます。CLIからQuantizerに接続したら<code
              class="language-plaintext highlighter-rouge"
              >debug on</code
            >を送信し、Quantizerに接続したキーボードやマウスを動かしてください。ホストICがデバイスを認識できていれば下記のようなメッセージが表示されます。
          </p>
          <ul>
            <li>
              キーを押したりマウスを操作したときのレポートを確認
              <ul>
                <li>先頭10バイトはホストICが付加したヘッダ</li>
                <li>サンプルの場合以下の三種類</li>
              </ul>
              <div class="language-bash highlighter-rouge">
                <div class="highlight">
                  <pre
                    class="highlight"
                  ><code><span class="c"># Aキーを押したとき</span>
Receive: device:0, ep:1
08 00 04 06 00 01 EF 17 47 60 00 00 04 00 00 00 00 00
<span class="c">#&lt;------    header     -----&gt;|&lt;-------report--------&gt;</span>

<span class="c"># カーソルを動かしたとき</span>
Receive: device:1, ep:2
06 00 04 02 01 02 EF 17 47 60 01 00 00 02 00 00
<span class="c">#&lt;------    header     -----&gt;|&lt;----report-----&gt;</span>

<span class="c"># 横スクロールしたとき</span>
Receive: device:1, ep:2
03 00 04 02 01 02 EF 17 47 60 16 FF 00
<span class="c">#&lt;------    header     -----&gt;|&lt;report&gt;</span>
</code></pre>
                </div>
              </div>
              <ul>
                <li>device0はキーボード</li>
                <li>
                  device1のID0はマウス(横スクロールは除く、xyは8bit)、ID0x16は横スクロール
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div class="search-overlay"></div>
    </div>
  </body>
</html>
